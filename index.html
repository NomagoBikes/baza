<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomago Bikes - BAZA Portal z Chat</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #004899;
            --secondary-yellow: #fbb900;
            --light-blue: #e9f0f7;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 72, 153, 0.1);
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
        }

        [data-theme="dark"] {
            --light-blue: #1a1a1a;
            --white: #2d2d2d;
            --text-dark: #f0f0f0;
            --text-light: #cccccc;
            --border-color: #444;
            --shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-blue) 0%, #004899 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            color: var(--text-dark);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body.loaded {
            opacity: 1;
        }

        /* Header styles */
        header {
            background: #004899;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            font-size: 1.2rem;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo .nom { color: white; }
        .logo .a { color: #fbb900; }
        .logo .go { color: white; }
        .logo .bikes { color: #fbb900; }

        .header-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-controls .logout-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: var(--danger);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .header-controls .logout-button:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .user-info {
            color: var(--white);
            font-size: 0.9rem;
            display: none;
        }

        /* Main styles */
        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .login-card {
            background: var(--white);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 72, 153, 0.15);
        }

        .bike-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
        }

        .login-title {
            color: var(--text-dark);
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-label {
            display: block;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--text-dark);
        }

        .form-input:focus {
            outline: none;
            border-color: #004899;
            box-shadow: 0 0 0 3px rgba(0, 72, 153, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 0.875rem;
            background: #004899;
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .login-button:hover {
            background: #003a7a;
            transform: translateY(-2px);
        }

        .login-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message, .success-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .success-message {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        /* Dashboard styles */
        .dashboard {
            display: none;
            flex: 1;
        }

        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: var(--white);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 2rem 2rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .sidebar-title {
            color: var(--text-dark);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            margin-bottom: 0.5rem;
        }

        .menu-button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border-left: 3px solid transparent;
            position: relative;
        }

        .menu-button:hover {
            background: rgba(0, 72, 153, 0.05);
            border-left-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .menu-button.active {
            background: rgba(0, 72, 153, 0.1);
            border-left-color: var(--primary-blue);
            color: var(--primary-blue);
            font-weight: 600;
        }

        .menu-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .logout-section {
            margin-top: auto;
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
        }

        .logout-button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--danger);
            color: var(--white);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            background: var(--light-blue);
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-title {
            color: var(--text-dark);
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        .content-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .content-section {
            display: none;
        }

        /* Chat Widget - Novo oblikovani */
        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: none;
        }

        .chat-bubble {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #004899 0%, #fbb900 100%);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 72, 153, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
        }

        .chat-bubble .icon {
            color: white;
            font-size: 24px;
        }

        .chat-notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
        }

        .chat-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 450px;
            max-width: 95vw;
            height: 650px;
            max-height: 85vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #004899 0%, #0056b3 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .chat-user-info {
            background: rgba(251, 185, 0, 0.1);
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #004899;
            font-weight: 500;
        }

        .chat-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .chat-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            color: #004899;
            border-bottom-color: #004899;
            background: white;
        }

        .chat-tab:hover {
            background: rgba(0, 72, 153, 0.1);
        }

        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-section {
            display: none;
            flex-direction: column;
            flex: 1;
        }

        .chat-section.active {
            display: flex;
        }

        /* Contacts section */
        .contacts-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contacts-search {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .contacts-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .contacts-search input:focus {
            border-color: #004899;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .contact-item:hover {
            background: #f0f0f0;
        }

        .contact-item.active {
            background: #e3f2fd;
            border-left: 4px solid #004899;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #004899, #fbb900);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            position: relative;
        }

        .contact-online {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border: 2px solid white;
            border-radius: 50%;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 2px;
        }

        .contact-last-message {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            font-size: 11px;
            color: #999;
        }

        .unread-badge {
            background: #ff4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 16px;
            text-align: center;
        }

        /* Messages section */
        .messages-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messages-title {
            flex: 1;
            font-weight: 600;
            color: #333;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-item {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message-item.sent {
            background: #004899;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-item.received {
            background: white;
            color: #333;
            align-self: flex-start;
            border: 1px solid #e0e0e0;
        }

        .message-sender {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .message-text {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            color: #666;
            font-size: 14px;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .message-input-container {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .message-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
        }

        .message-input-wrapper:focus-within {
            border-color: #004899;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: none;
            padding: 8px;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 20px;
        }

        .send-button {
            background: #004899;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background: #003a7a;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            line-height: 1.4;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #004899;
            color: white;
        }

        .btn-primary:hover {
            background: #003a7a;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-window {
                width: 100vw;
                height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
                max-width: none;
                max-height: none;
            }

            .message-item {
                max-width: 85%;
            }

            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main-content {
                order: 1;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <div class="logo" onclick="goToHomePage()">
                <span class="nom">NOM</span><span class="a">A</span><span class="go">GO</span> <span class="bikes">bikes</span>
            </div>
        </div>
        <div class="header-center" id="headerCenter" style="display: none;">
            <h1 style="color: white; font-size: 1.8rem; font-weight: 700; letter-spacing: 1px; margin: 0;">BAZA</h1>
        </div>
        <div class="header-controls">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-button" id="headerLogoutBtn" onclick="logout()" style="display: none;" title="Odjavi se">
                <span class="menu-icon">🚪</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Preklopi temo">
                <span id="themeIcon">🌙</span>
            </button>
        </div>
    </header>

    <main>
        <!-- Login Section -->
        <div class="login-card" id="loginSection">
            <div class="bike-icon">🚲</div>
            <h1 class="login-title">Dobrodošli v Nomago Bikes</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">Uporabniško ime</label>
                    <input type="text" class="form-input" id="username" placeholder="Vnesite uporabniško ime" required autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Geslo</label>
                    <input type="password" class="form-input" id="password" placeholder="Vnesite geslo" required>
                </div>
                <button type="submit" class="login-button" id="loginButton">Prijavi se</button>
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div class="dashboard" id="dashboardSection">
            <div class="dashboard-container">
                <!-- Sidebar Menu -->
                <nav class="sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-title">Upravljanje</div>
                        <div class="sidebar-subtitle">Nomago Bikes Portal</div>
                    </div>
                    <ul class="menu-list">
                        <li class="menu-item">
                            <button class="menu-button active" onclick="showContent('dashboard')">
                                <span class="menu-icon">🏠</span>
                                <span>Nadzorna plošča</span>
                            </button>
                        </li>
                        <li class="menu-item">
                            <button class="menu-button" onclick="showContent('chat')">
                                <span class="menu-icon">💬</span>
                                <span>Chat</span>
                            </button>
                        </li>
                    </ul>
                    <div class="logout-section">
                        <button class="logout-button" onclick="logout()">
                            <span class="menu-icon">🚪</span>
                            <span>Odjavi se</span>
                        </button>
                    </div>
                </nav>

                <!-- Main Content Area -->
                <main class="main-content">
                    <!-- Dashboard Content -->
                    <div class="content-section" id="dashboardContent" style="display: block;">
                        <div class="content-header">
                            <h1 class="content-title">Nadzorna plošča</h1>
                            <p class="content-subtitle">Dobrodošli v Nomago Bikes upravljavskem portalu</p>
                        </div>
                        <div class="content-card">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">🚴‍♂️</div>
                                <h2 style="color: var(--text-dark); font-size: 1.5rem; margin-bottom: 1rem;">Uspešno ste se prijavili!</h2>
                                <p style="color: var(--text-light); font-size: 1rem; line-height: 1.6;">
                                    Uporabite levi meni za navigacijo po različnih funkcijah portala. 
                                    Novi chat sistem omogoča komunikacijo z drugimi uporabniki.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Content -->
                    <div class="content-section" id="chatContent">
                        <div class="content-header">
                            <h1 class="content-title">Chat sistem</h1>
                            <p class="content-subtitle">Komunicirajte z drugimi uporabniki v realnem času</p>
                        </div>
                        <div class="content-card" style="padding: 0; height: 70vh; display: flex; flex-direction: column;">
                            
                            <!-- Chat Header -->
                            <div class="chat-header" style="border-radius: 12px 12px 0 0; margin: 0;">
                                <div class="chat-title">
                                    <span>💬</span>
                                    <span>Nomago Chat</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-small" onclick="openNewChatModal()">+ Nova</button>
                                    <button class="btn btn-secondary btn-small" onclick="refreshChats()">🔄</button>
                                </div>
                            </div>

                            <!-- Chat Body -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                
                                <!-- Left Side - Contacts -->
                                <div style="width: 300px; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; background: #f8f9fa;">
                                    
                                    <!-- Search -->
                                    <div class="contacts-search">
                                        <input type="text" placeholder="Iskanje kontaktov..." onkeyup="searchContacts(this.value)">
                                    </div>

                                    <!-- Tabs -->
                                    <div class="chat-tabs" style="border-bottom: 1px solid #e0e0e0; margin: 0;">
                                        <button class="chat-tab active" onclick="switchContactsTab('all')">Vsi</button>
                                        <button class="chat-tab" onclick="switchContactsTab('groups')">Skupine</button>
                                        <button class="chat-tab" onclick="switchContactsTab('direct')">Neposredno</button>
                                    </div>

                                    <!-- Contacts List -->
                                    <div class="contacts-list" id="contactsList">
                                        <!-- Contacts will be loaded here -->
                                    </div>
                                </div>

                                <!-- Right Side - Messages -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    
                                    <!-- Empty State -->
                                    <div class="empty-state" id="chatEmptyState">
                                        <div class="empty-state-icon">💬</div>
                                        <h3>Izberite pogovor</h3>
                                        <p>Kliknite na kontakt ali skupino za začetek pogovora</p>
                                    </div>

                                    <!-- Active Chat -->
                                    <div id="activeChatView" style="display: none; flex: 1; flex-direction: column;">
                                        
                                        <!-- Chat Header -->
                                        <div class="messages-header">
                                            <div class="contact-avatar" id="activeChatAvatar">U</div>
                                            <div class="messages-title">
                                                <div id="activeChatName">Kontakt</div>
                                                <div id="activeChatStatus" style="font-size: 12px; color: #666;">Online</div>
                                            </div>
                                            <div>
                                                <button class="btn btn-secondary btn-small" onclick="openChatSettings()">⚙️</button>
                                            </div>
                                        </div>

                                        <!-- Typing Indicator -->
                                        <div class="typing-indicator" id="typingIndicator">
                                            <span id="typingUser">Uporabnik</span> piše
                                            <div class="typing-dots">
                                                <div class="typing-dot"></div>
                                                <div class="typing-dot"></div>
                                                <div class="typing-dot"></div>
                                            </div>
                                        </div>

                                        <!-- Messages -->
                                        <div class="messages-container" id="messagesContainer">
                                            <!-- Messages will be loaded here -->
                                        </div>

                                        <!-- Message Input -->
                                        <div class="message-input-container">
                                            <div class="message-input-wrapper">
                                                <textarea class="message-input" id="messageInput" placeholder="Napišite sporočilo..." 
                                                          rows="1" oninput="adjustTextareaHeight(this); handleTyping()"></textarea>
                                                <button class="send-button" onclick="sendMessage()" disabled>
                                                    <span>➤</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </main>

    <!-- Chat Widget (for other pages) -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-bubble" onclick="toggleChatWidget()">
            <span class="icon">💬</span>
            <div class="chat-notification-badge" id="chatNotificationBadge">0</div>
        </div>
        <div class="chat-window" id="chatWidgetWindow">
            <div class="chat-header">
                <div class="chat-title">
                    <span>💬</span>
                    <span>Nomago Chat</span>
                </div>
                <button class="chat-close" onclick="toggleChatWidget()">&times;</button>
            </div>
            <div class="chat-user-info" id="chatWidgetUser">Chat uporabnik</div>
            
            <div class="chat-tabs">
                <button class="chat-tab active" onclick="switchWidgetTab('messages')">💬 Sporočila</button>
                <button class="chat-tab" onclick="switchWidgetTab('contacts')">👥 Kontakti</button>
            </div>
            
            <div class="chat-content">
                <!-- Messages Section -->
                <div class="chat-section active" id="widgetMessagesSection">
                    <div class="messages-container" id="widgetMessagesContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">💬</div>
                            <h3>Dobrodošli v Chat!</h3>
                            <p>Izberite kontakt za začetek pogovora</p>
                        </div>
                    </div>
                    <div class="message-input-container">
                        <div class="message-input-wrapper">
                            <textarea id="widgetMessageInput" class="message-input" placeholder="Napišite sporočilo..."></textarea>
                            <button class="send-button" onclick="sendWidgetMessage()">➤</button>
                        </div>
                    </div>
                </div>
                
                <!-- Contacts Section -->
                <div class="chat-section" id="widgetContactsSection">
                    <div class="contacts-header">
                        <h4>Kontakti</h4>
                        <button class="btn btn-primary btn-small" onclick="openNewChatModal()">+ Nova</button>
                    </div>
                    <div class="contacts-list" id="widgetContactsList">
                        <!-- Contacts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova skupina/pogovor</h3>
                <button class="modal-close" onclick="closeNewChatModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Tip:</label>
                <select class="form-input" id="chatType" onchange="toggleChatTypeOptions()">
                    <option value="direct">Neposreden pogovor</option>
                    <option value="group">Skupina</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" id="nameLabel">Uporabniško ime:</label>
                <input type="text" class="form-input" id="chatNameInput" placeholder="Vnesite ime...">
            </div>
            <div class="form-group" id="groupOptions" style="display: none;">
                <label class="form-label">Opis skupine:</label>
                <textarea class="form-input" id="groupDescription" placeholder="Kratek opis skupine..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeNewChatModal()">Prekliči</button>
                <button class="btn btn-primary" onclick="createNewChat()">Ustvari</button>
            </div>
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div id="chatSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nastavitve pogovora</h3>
                <button class="modal-close" onclick="closeChatSettingsModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Ime:</label>
                <input type="text" class="form-input" id="chatSettingsName" placeholder="Ime pogovora...">
            </div>
            <div class="form-group" id="chatMembersSection">
                <label class="form-label">Člani:</label>
                <div id="chatMembersList">
                    <!-- Members will be loaded here -->
                </div>
            </div>
            <div class="form-group" id="addMemberSection">
                <label class="form-label">Dodaj člana:</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="newMemberInput" placeholder="Uporabniško ime...">
                    <button class="btn btn-primary" onclick="addMemberToChat()">Dodaj</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeChatSettingsModal()">Zapri</button>
                <button class="btn btn-primary" onclick="saveChatSettings()">Shrani</button>
            </div>
        </div>
    </div>

    <!-- Firebase Integration Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            deleteDoc,
            updateDoc,
            addDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            serverTimestamp,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrhPYvef_YZbISHxWeZL0MuQVAQYtTN4M",
            authDomain: "nomago-bikes-portal-f33da.firebaseapp.com",
            projectId: "nomago-bikes-portal-f33da",
            storageBucket: "nomago-bikes-portal-f33da.firebasestorage.app",
            messagingSenderId: "647987655592",
            appId: "1:647987655592:web:7731d4ca344ce804bdc96d",
            measurementId: "G-D1CBD3V7ZV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions globally available
        window.firebaseDb = db;
        window.firebaseFunctions = {
            collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, addDoc,
            query, where, orderBy, onSnapshot, serverTimestamp, arrayUnion, arrayRemove
        };

        console.log("Firebase initialized successfully");
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let currentChat = null;
        let currentContactsTab = 'all';
        let chatContacts = [];
        let chatMessages = {};
        let messageListeners = [];
        let typingTimeout = null;
        let unreadCounts = {};

        // Initialize app with proper loading sequence
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Show page immediately with fade-in effect
                setTimeout(() => {
                    document.body.classList.add('loaded');
                }, 100);
                
                loadTheme();
                
                // Wait for Firebase to be ready
                await waitForFirebase();
                console.log('Firebase is ready');
                
                // Initialize Firebase and default data
                await initializeDefaultData();
                
                // Check login status
                checkLoginStatus();
                
            } catch (error) {
                console.error('Error during initialization:', error);
                document.body.classList.add('loaded');
            }
            
            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            setupChatEventListeners();
        });

        // Wait for Firebase to be fully loaded
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDb && window.firebaseFunctions && window.firebaseFunctions.getDoc) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Initialize default users and data in Firebase
        async function initializeDefaultData() {
            try {
                // Check if admin user exists
                const adminDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', 'admin')
                );

                if (!adminDoc.exists()) {
                    // Create default admin user
                    const defaultAdmin = {
                        ime: 'Admin',
                        priimek: 'Administrator',
                        uporabniskoIme: 'admin',
                        geslo: 'admin123',
                        vloga: 'admin',
                        sistemi: ['KolesCE', 'LUR', 'GO2GO', 'KOR', 'ZaNaprej'],
                        createdAt: window.firebaseFunctions.serverTimestamp(),
                        chatProfile: {
                            displayName: 'Admin Administrator',
                            avatar: 'A',
                            status: 'online',
                            lastSeen: window.firebaseFunctions.serverTimestamp()
                        }
                    };

                    await window.firebaseFunctions.setDoc(
                        window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', 'admin'),
                        defaultAdmin
                    );

                    console.log('Default admin user created');
                }

                // Create default test users for chat
                const defaultUsers = [
                    {
                        ime: 'Marko',
                        priimek: 'Serviser',
                        uporabniskoIme: 'marko',
                        geslo: 'marko123',
                        vloga: 'serviser',
                        sistemi: ['KolesCE', 'LUR'],
                        chatProfile: {
                            displayName: 'Marko Serviser',
                            avatar: 'M',
                            status: 'online',
                            lastSeen: window.firebaseFunctions.serverTimestamp()
                        }
                    },
                    {
                        ime: 'Ana',
                        priimek: 'Novak',
                        uporabniskoIme: 'ana',
                        geslo: 'ana123',
                        vloga: 'student',
                        sistemi: ['KolesCE'],
                        chatProfile: {
                            displayName: 'Ana Novak',
                            avatar: 'A',
                            status: 'offline',
                            lastSeen: window.firebaseFunctions.serverTimestamp()
                        }
                    },
                    {
                        ime: 'Petra',
                        priimek: 'Kovač',
                        uporabniskoIme: 'petra',
                        geslo: 'petra123',
                        vloga: 'student',
                        sistemi: ['LUR'],
                        chatProfile: {
                            displayName: 'Petra Kovač',
                            avatar: 'P',
                            status: 'online',
                            lastSeen: window.firebaseFunctions.serverTimestamp()
                        }
                    }
                ];

                for (const user of defaultUsers) {
                    const userDoc = await window.firebaseFunctions.getDoc(
                        window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', user.uporabniskoIme)
                    );

                    if (!userDoc.exists()) {
                        await window.firebaseFunctions.setDoc(
                            window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', user.uporabniskoIme),
                            { ...user, createdAt: window.firebaseFunctions.serverTimestamp() }
                        );
                        console.log(`Default user ${user.uporabniskoIme} created`);
                    }
                }

                // Create default chat groups
                await createDefaultChatGroups();

            } catch (error) {
                console.error('Error initializing default data:', error);
            }
        }

        // Create default chat groups
        async function createDefaultChatGroups() {
            try {
                // Check if default groups exist
                const groupsSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDb, 'chatRooms')
                );

                if (groupsSnapshot.empty) {
                    // Create default groups
                    const defaultGroups = [
                        {
                            name: 'Vsi zaposleni',
                            description: 'Glavna skupina za vse zaposlene',
                            type: 'group',
                            members: ['admin', 'marko', 'ana', 'petra'],
                            createdBy: 'admin',
                            createdAt: window.firebaseFunctions.serverTimestamp(),
                            avatar: 'V'
                        },
                        {
                            name: 'Serviserji',
                            description: 'Skupina za serviserje',
                            type: 'group',
                            members: ['admin', 'marko'],
                            createdBy: 'admin',
                            createdAt: window.firebaseFunctions.serverTimestamp(),
                            avatar: 'S'
                        }
                    ];

                    for (const group of defaultGroups) {
                        await window.firebaseFunctions.addDoc(
                            window.firebaseFunctions.collection(window.firebaseDb, 'chatRooms'),
                            group
                        );
                        console.log(`Default group ${group.name} created`);
                    }
                }
            } catch (error) {
                console.error('Error creating default chat groups:', error);
            }
        }

        // Setup chat event listeners
        function setupChatEventListeners() {
            // Message input handling
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener('input', function() {
                    const sendBtn = document.querySelector('.send-button');
                    if (sendBtn) {
                        sendBtn.disabled = this.value.trim() === '';
                    }
                });
            }

            // Widget message input handling
            const widgetMessageInput = document.getElementById('widgetMessageInput');
            if (widgetMessageInput) {
                widgetMessageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendWidgetMessage();
                    }
                });
            }

            // Modal event listeners
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeNewChatModal();
                    closeChatSettingsModal();
                }
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeNewChatModal();
                    closeChatSettingsModal();
                }
            });
        }

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                sessionStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                sessionStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = sessionStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            }
        }

        // Login handling with Firebase
        async function handleLogin(event) {
            event.preventDefault();
            
            const loginButton = document.getElementById('loginButton');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('Prosimo, vnesite uporabniško ime in geslo.', 'error');
                return;
            }
            
            loginButton.textContent = 'Prijavljanje...';
            loginButton.disabled = true;
            
            try {
                // Get user from Firebase
                const userDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', username)
                );
                
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    if (user.geslo === password) {
                        currentUser = user;
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        
                        // Update user's online status
                        await updateUserStatus('online');
                        
                        showMessage('Uspešna prijava!', 'success');
                        setTimeout(() => showDashboard(user), 1000);
                    } else {
                        showMessage('Napačno geslo.', 'error');
                    }
                } else {
                    showMessage('Uporabnik ne obstaja.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Prišlo je do napake pri prijavi.', 'error');
            } finally {
                loginButton.textContent = 'Prijavi se';
                loginButton.disabled = false;
            }
        }

        function showMessage(message, type) {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            if (type === 'error') {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            } else if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            }
        }

        function showDashboard(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('headerLogoutBtn').style.display = 'flex';
            document.getElementById('headerCenter').style.display = 'block';
            document.getElementById('userInfo').textContent = `${user.ime} ${user.priimek} (${user.vloga})`;
            document.getElementById('chatWidget').style.display = 'block';
            
            // Initialize chat system
            initializeChatSystem();
        }

        // Initialize chat system
        async function initializeChatSystem() {
            try {
                await loadChatContacts();
                setupChatListeners();
                
                // Update chat user info
                const chatUserInfo = document.getElementById('chatWidgetUser');
                if (chatUserInfo && currentUser) {
                    chatUserInfo.textContent = `${currentUser.ime} ${currentUser.priimek}`;
                }
                
                console.log('Chat system initialized');
            } catch (error) {
                console.error('Error initializing chat system:', error);
            }
        }

        // Load chat contacts
        async function loadChatContacts() {
            try {
                // Load all users
                const usersSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDb, 'uporabniki')
                );
                
                // Load chat rooms
                const roomsSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDb, 'chatRooms')
                );
                
                chatContacts = [];
                
                // Add direct contacts (other users)
                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.uporabniskoIme !== currentUser.uporabniskoIme) {
                        chatContacts.push({
                            id: user.uporabniskoIme,
                            name: user.chatProfile?.displayName || `${user.ime} ${user.priimek}`,
                            avatar: user.chatProfile?.avatar || user.ime.charAt(0),
                            type: 'direct',
                            online: user.chatProfile?.status === 'online',
                            lastMessage: '',
                            lastMessageTime: null,
                            unread: 0
                        });
                    }
                });
                
                // Add group contacts
                roomsSnapshot.forEach((doc) => {
                    const room = doc.data();
                    if (room.members && room.members.includes(currentUser.uporabniskoIme)) {
                        chatContacts.push({
                            id: doc.id,
                            name: room.name,
                            avatar: room.avatar || room.name.charAt(0),
                            type: 'group',
                            online: true,
                            lastMessage: '',
                            lastMessageTime: null,
                            unread: 0,
                            members: room.members,
                            description: room.description
                        });
                    }
                });
                
                // Sort contacts by last message time
                chatContacts.sort((a, b) => {
                    if (!a.lastMessageTime && !b.lastMessageTime) return 0;
                    if (!a.lastMessageTime) return 1;
                    if (!b.lastMessageTime) return -1;
                    return b.lastMessageTime - a.lastMessageTime;
                });
                
                // Update contacts display
                updateContactsDisplay();
                
            } catch (error) {
                console.error('Error loading chat contacts:', error);
            }
        }

        // Update contacts display
        function updateContactsDisplay() {
            const contactsList = document.getElementById('contactsList');
            const widgetContactsList = document.getElementById('widgetContactsList');
            
            if (!contactsList || !widgetContactsList) return;
            
            let filteredContacts = chatContacts;
            
            // Filter by tab
            if (currentContactsTab === 'groups') {
                filteredContacts = chatContacts.filter(c => c.type === 'group');
            } else if (currentContactsTab === 'direct') {
                filteredContacts = chatContacts.filter(c => c.type === 'direct');
            }
            
            const contactsHTML = filteredContacts.map(contact => {
                const unreadBadge = contact.unread > 0 ? `<div class="unread-badge">${contact.unread}</div>` : '';
                const onlineIndicator = contact.online ? '<div class="contact-online"></div>' : '';
                const lastMessage = contact.lastMessage ? contact.lastMessage.substring(0, 30) + '...' : 'Še ni sporočil';
                
                return `
                    <div class="contact-item" onclick="selectContact('${contact.id}')">
                        <div class="contact-avatar">
                            ${contact.avatar}
                            ${contact.type === 'direct' ? onlineIndicator : ''}
                        </div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-last-message">${lastMessage}</div>
                        </div>
                        <div>
                            ${unreadBadge}
                            ${contact.lastMessageTime ? `<div class="contact-time">${formatTime(contact.lastMessageTime)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsList.innerHTML = contactsHTML;
            widgetContactsList.innerHTML = contactsHTML;
        }

        // Select contact for chat
        async function selectContact(contactId) {
            try {
                const contact = chatContacts.find(c => c.id === contactId);
                if (!contact) return;
                
                currentChat = contact;
                
                // Mark as read
                contact.unread = 0;
                updateContactsDisplay();
                
                // Update UI
                document.getElementById('chatEmptyState').style.display = 'none';
                document.getElementById('activeChatView').style.display = 'flex';
                
                // Update chat header
                document.getElementById('activeChatAvatar').textContent = contact.avatar;
                document.getElementById('activeChatName').textContent = contact.name;
                document.getElementById('activeChatStatus').textContent = contact.online ? 'Online' : 'Offline';
                
                // Load messages
                await loadChatMessages(contactId);
                
                // Mark all contacts as inactive, then mark selected as active
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.contact-item').classList.add('active');
                
            } catch (error) {
                console.error('Error selecting contact:', error);
            }
        }

        // Load messages for a chat
        async function loadChatMessages(contactId) {
            try {
                const contact = chatContacts.find(c => c.id === contactId);
                if (!contact) return;
                
                // Clean up existing listeners
                messageListeners.forEach(unsubscribe => unsubscribe());
                messageListeners = [];
                
                let messagesQuery;
                
                if (contact.type === 'direct') {
                    // For direct chats, find messages between current user and contact
                    messagesQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebaseDb, 'chatMessages'),
                        window.firebaseFunctions.where('participants', 'array-contains', currentUser.uporabniskoIme),
                        window.firebaseFunctions.orderBy('timestamp', 'asc')
                    );
                } else {
                    // For group chats, find messages in the room
                    messagesQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebaseDb, 'chatMessages'),
                        window.firebaseFunctions.where('roomId', '==', contactId),
                        window.firebaseFunctions.orderBy('timestamp', 'asc')
                    );
                }
                
                // Set up real-time listener
                const unsubscribe = window.firebaseFunctions.onSnapshot(messagesQuery, (snapshot) => {
                    const messages = [];
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        
                        // Filter messages for direct chats
                        if (contact.type === 'direct') {
                            const participants = messageData.participants || [];
                            if (participants.includes(currentUser.uporabniskoIme) && participants.includes(contactId)) {
                                messages.push({
                                    id: doc.id,
                                    ...messageData
                                });
                            }
                        } else {
                            // For group chats, include all messages
                            messages.push({
                                id: doc.id,
                                ...messageData
                            });
                        }
                    });
                    
                    displayMessages(messages);
                });
                
                messageListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        // Display messages in chat
        function displayMessages(messages) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            messages.forEach((message) => {
                const messageElement = document.createElement('div');
                const isSent = message.senderId === currentUser.uporabniskoIme;
                messageElement.className = `message-item ${isSent ? 'sent' : 'received'}`;
                
                let senderName = '';
                if (!isSent && currentChat.type === 'group') {
                    const sender = chatContacts.find(c => c.id === message.senderId);
                    senderName = `<div class="message-sender">${sender ? sender.name : message.senderName || 'Neznani uporabnik'}</div>`;
                }
                
                messageElement.innerHTML = `
                    ${senderName}
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${formatTime(message.timestamp?.toDate ? message.timestamp.toDate() : new Date(message.timestamp))}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChat) return;
            
            try {
                const messageData = {
                    text: messageText,
                    senderId: currentUser.uporabniskoIme,
                    senderName: currentUser.chatProfile?.displayName || `${currentUser.ime} ${currentUser.priimek}`,
                    timestamp: window.firebaseFunctions.serverTimestamp()
                };
                
                if (currentChat.type === 'direct') {
                    messageData.participants = [currentUser.uporabniskoIme, currentChat.id];
                    messageData.type = 'direct';
                } else {
                    messageData.roomId = currentChat.id;
                    messageData.type = 'group';
                }
                
                await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDb, 'chatMessages'),
                    messageData
                );
                
                messageInput.value = '';
                document.querySelector('.send-button').disabled = true;
                
                // Update last message for contact
                currentChat.lastMessage = messageText;
                currentChat.lastMessageTime = new Date();
                updateContactsDisplay();
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Napaka pri pošiljanju sporočila: ' + error.message);
            }
        }

        // Send widget message
        async function sendWidgetMessage() {
            const messageInput = document.getElementById('widgetMessageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChat) return;
            
            try {
                const messageData = {
                    text: messageText,
                    senderId: currentUser.uporabniskoIme,
                    senderName: currentUser.chatProfile?.displayName || `${currentUser.ime} ${currentUser.priimek}`,
                    timestamp: window.firebaseFunctions.serverTimestamp()
                };
                
                if (currentChat.type === 'direct') {
                    messageData.participants = [currentUser.uporabniskoIme, currentChat.id];
                    messageData.type = 'direct';
                } else {
                    messageData.roomId = currentChat.id;
                    messageData.type = 'group';
                }
                
                await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDb, 'chatMessages'),
                    messageData
                );
                
                messageInput.value = '';
                
            } catch (error) {
                console.error('Error sending widget message:', error);
                alert('Napaka pri pošiljanju sporočila: ' + error.message);
            }
        }

        // Setup chat listeners for real-time updates
        function setupChatListeners() {
            // Listen for new messages to update unread counts
            const allMessagesQuery = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(window.firebaseDb, 'chatMessages'),
                window.firebaseFunctions.orderBy('timestamp', 'desc')
            );
            
            window.firebaseFunctions.onSnapshot(allMessagesQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        
                        // Skip own messages
                        if (message.senderId === currentUser.uporabniskoIme) return;
                        
                        // Update unread count
                        let contactId;
                        if (message.type === 'direct') {
                            contactId = message.participants.find(p => p !== currentUser.uporabniskoIme);
                        } else {
                            contactId = message.roomId;
                        }
                        
                        const contact = chatContacts.find(c => c.id === contactId);
                        if (contact && (!currentChat || currentChat.id !== contactId)) {
                            contact.unread = (contact.unread || 0) + 1;
                            contact.lastMessage = message.text;
                            contact.lastMessageTime = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
                            
                            updateContactsDisplay();
                            updateNotificationBadge();
                            
                            // Show browser notification
                            showBrowserNotification(contact.name, message.text);
                        }
                    }
                });
            });
        }

        // Update notification badge
        function updateNotificationBadge() {
            const totalUnread = chatContacts.reduce((sum, contact) => sum + (contact.unread || 0), 0);
            const badge = document.getElementById('chatNotificationBadge');
            
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show browser notification
        function showBrowserNotification(senderName, messageText) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`${senderName} - Nomago Chat`, {
                    body: messageText,
                    icon: "/favicon.ico"
                });
            }
        }

        // Update user online status
        async function updateUserStatus(status) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', currentUser.uporabniskoIme),
                    {
                        'chatProfile.status': status,
                        'chatProfile.lastSeen': window.firebaseFunctions.serverTimestamp()
                    }
                );
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        // Content management
        function showContent(contentType) {
            if (!currentUser) {
                alert('Niste prijavljeni.');
                return;
            }
            
            const sections = ['dashboardContent', 'chatContent'];
            sections.forEach(section => {
                const el = document.getElementById(section);
                if (el) el.style.display = 'none';
            });

            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.classList.remove('active');
            });

            switch(contentType) {
                case 'dashboard':
                    document.getElementById('dashboardContent').style.display = 'block';
                    document.querySelector('[onclick="showContent(\'dashboard\')"]').classList.add('active');
                    break;
                case 'chat':
                    document.getElementById('chatContent').style.display = 'block';
                    document.querySelector('[onclick="showContent(\'chat\')"]').classList.add('active');
                    break;
            }
        }

        // Chat widget functions
        function toggleChatWidget() {
            const chatWindow = document.getElementById('chatWidgetWindow');
            const isVisible = chatWindow.style.display === 'flex';
            chatWindow.style.display = isVisible ? 'none' : 'flex';
        }

        function switchWidgetTab(tab) {
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.chat-section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'messages') {
                document.getElementById('widgetMessagesSection').classList.add('active');
            } else if (tab === 'contacts') {
                document.getElementById('widgetContactsSection').classList.add('active');
            }
        }

        // Switch contacts tab
        function switchContactsTab(tab) {
            currentContactsTab = tab;
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            updateContactsDisplay();
        }

        // Search contacts
        function searchContacts(query) {
            const items = document.querySelectorAll('.contact-item');
            items.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Modal functions
        function openNewChatModal() {
            document.getElementById('newChatModal').style.display = 'block';
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').style.display = 'none';
            document.getElementById('chatNameInput').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function toggleChatTypeOptions() {
            const chatType = document.getElementById('chatType').value;
            const groupOptions = document.getElementById('groupOptions');
            const nameLabel = document.getElementById('nameLabel');
            
            if (chatType === 'group') {
                groupOptions.style.display = 'block';
                nameLabel.textContent = 'Ime skupine:';
                document.getElementById('chatNameInput').placeholder = 'Vnesite ime skupine...';
            } else {
                groupOptions.style.display = 'none';
                nameLabel.textContent = 'Uporabniško ime:';
                document.getElementById('chatNameInput').placeholder = 'Vnesite uporabniško ime...';
            }
        }

        // Create new chat
        async function createNewChat() {
            const chatType = document.getElementById('chatType').value;
            const chatName = document.getElementById('chatNameInput').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            
            if (!chatName) {
                alert('Prosimo, vnesite ime!');
                return;
            }
            
            try {
                if (chatType === 'group') {
                    // Create new group
                    const groupData = {
                        name: chatName,
                        description: groupDescription,
                        type: 'group',
                        members: [currentUser.uporabniskoIme],
                        createdBy: currentUser.uporabniskoIme,
                        createdAt: window.firebaseFunctions.serverTimestamp(),
                        avatar: chatName.charAt(0).toUpperCase()
                    };
                    
                    await window.firebaseFunctions.addDoc(
                        window.firebaseFunctions.collection(window.firebaseDb, 'chatRooms'),
                        groupData
                    );
                    
                    alert('Skupina je bila uspešno ustvarjena!');
                } else {
                    // Check if user exists
                    const userDoc = await window.firebaseFunctions.getDoc(
                        window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', chatName)
                    );
                    
                    if (!userDoc.exists()) {
                        alert('Uporabnik ne obstaja!');
                        return;
                    }
                    
                    // Check if chat already exists
                    const existingContact = chatContacts.find(c => c.id === chatName && c.type === 'direct');
                    if (existingContact) {
                        alert('Pogovor s tem uporabnikom že obstaja!');
                        return;
                    }
                    
                    alert('Uporabnik je bil dodan v kontakte!');
                }
                
                closeNewChatModal();
                await loadChatContacts();
                
            } catch (error) {
                console.error('Error creating new chat:', error);
                alert('Napaka pri ustvarjanju pogovora: ' + error.message);
            }
        }

        // Chat settings
        function openChatSettings() {
            if (!currentChat) return;
            
            document.getElementById('chatSettingsModal').style.display = 'block';
            document.getElementById('chatSettingsName').value = currentChat.name;
            
            if (currentChat.type === 'group') {
                document.getElementById('chatMembersSection').style.display = 'block';
                document.getElementById('addMemberSection').style.display = 'block';
                loadChatMembers();
            } else {
                document.getElementById('chatMembersSection').style.display = 'none';
                document.getElementById('addMemberSection').style.display = 'none';
            }
        }

        function closeChatSettingsModal() {
            document.getElementById('chatSettingsModal').style.display = 'none';
        }

        function loadChatMembers() {
            if (!currentChat || !currentChat.members) return;
            
            const membersList = document.getElementById('chatMembersList');
            membersList.innerHTML = '';
            
            currentChat.members.forEach(memberId => {
                const member = chatContacts.find(c => c.id === memberId) || { id: memberId, name: 'Uporabnik ' + memberId };
                
                const memberElement = document.createElement('div');
                memberElement.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px;';
                
                memberElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: #004899; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                            ${member.name.charAt(0).toUpperCase()}
                        </div>
                        <span>${member.name}</span>
                        ${memberId === currentUser.uporabniskoIme ? '<span style="color: #666; font-size: 12px;">(vi)</span>' : ''}
                    </div>
                    ${memberId !== currentUser.uporabniskoIme ? `<button class="btn btn-secondary btn-small" onclick="removeMemberFromChat('${memberId}')">Odstrani</button>` : ''}
                `;
                
                membersList.appendChild(memberElement);
            });
        }

        // Add member to chat
        async function addMemberToChat() {
            const newMemberName = document.getElementById('newMemberInput').value.trim();
            
            if (!newMemberName) {
                alert('Prosimo, vnesite ime člana!');
                return;
            }
            
            try {
                // Check if user exists
                const userDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', newMemberName)
                );
                
                if (!userDoc.exists()) {
                    alert('Uporabnik ne obstaja!');
                    return;
                }
                
                // Check if already a member
                if (currentChat.members.includes(newMemberName)) {
                    alert('Uporabnik je že član te skupine!');
                    return;
                }
                
                // Add member to group
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'chatRooms', currentChat.id),
                    {
                        members: window.firebaseFunctions.arrayUnion(newMemberName)
                    }
                );
                
                currentChat.members.push(newMemberName);
                document.getElementById('newMemberInput').value = '';
                loadChatMembers();
                
                alert('Član je bil uspešno dodan!');
                
            } catch (error) {
                console.error('Error adding member:', error);
                alert('Napaka pri dodajanju člana: ' + error.message);
            }
        }

        // Remove member from chat
        async function removeMemberFromChat(memberId) {
            if (!confirm('Ali ste prepričani, da želite odstraniti tega člana iz skupine?')) {
                return;
            }
            
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'chatRooms', currentChat.id),
                    {
                        members: window.firebaseFunctions.arrayRemove(memberId)
                    }
                );
                
                currentChat.members = currentChat.members.filter(id => id !== memberId);
                loadChatMembers();
                
                alert('Član je bil odstranjen!');
                
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Napaka pri odstranjevanju člana: ' + error.message);
            }
        }

        // Save chat settings
        async function saveChatSettings() {
            const newName = document.getElementById('chatSettingsName').value.trim();
            
            if (!newName) {
                alert('Prosimo, vnesite ime!');
                return;
            }
            
            try {
                if (currentChat.type === 'group') {
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebaseDb, 'chatRooms', currentChat.id),
                        {
                            name: newName
                        }
                    );
                }
                
                currentChat.name = newName;
                document.getElementById('activeChatName').textContent = newName;
                updateContactsDisplay();
                closeChatSettingsModal();
                
                alert('Nastavitve so bile shranjene!');
                
            } catch (error) {
                console.error('Error saving chat settings:', error);
                alert('Napaka pri shranjevanju nastavitev: ' + error.message);
            }
        }

        // Refresh chats
        async function refreshChats() {
            try {
                await loadChatContacts();
                alert('Kontakti so bili osveženi!');
            } catch (error) {
                console.error('Error refreshing chats:', error);
                alert('Napaka pri osveževanju kontaktov: ' + error.message);
            }
        }

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const now = new Date();
            const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
            const diff = now - date;
            
            if (diff < 60000) { // less than 1 minute
                return 'Pravkar';
            } else if (diff < 3600000) { // less than 1 hour
                return Math.floor(diff / 60000) + ' min';
            } else if (diff < 86400000) { // less than 1 day
                return Math.floor(diff / 3600000) + ' h';
            } else {
                return date.toLocaleDateString('sl-SI');
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleTyping() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                // Here you would send a "stopped typing" signal
            }, 1000);
        }

        // Logout
        async function logout() {
            if (currentUser) {
                await updateUserStatus('offline');
            }
            
            // Clean up listeners
            messageListeners.forEach(unsubscribe => unsubscribe());
            messageListeners = [];
            
            currentUser = null;
            currentChat = null;
            sessionStorage.removeItem('currentUser');
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('headerLogoutBtn').style.display = 'none';
            document.getElementById('headerCenter').style.display = 'none';
            document.getElementById('chatWidget').style.display = 'none';
            
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Check login status
        function checkLoginStatus() {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('loginSection').style.display = 'none';
                    showDashboard(currentUser);
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    sessionStorage.removeItem('currentUser');
                }
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
            }
        }

        // Navigate to home page when logo is clicked
        function goToHomePage() {
            if (currentUser) {
                showContent('dashboard');
            }
        }

        // Request notification permission
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // Make functions globally available
        window.toggleTheme = toggleTheme;
        window.logout = logout;
        window.showContent = showContent;
        window.goToHomePage = goToHomePage;
        window.selectContact = selectContact;
        window.toggleChatWidget = toggleChatWidget;
        window.switchWidgetTab = switchWidgetTab;
        window.switchContactsTab = switchContactsTab;
        window.searchContacts = searchContacts;
        window.sendMessage = sendMessage;
        window.sendWidgetMessage = sendWidgetMessage;
        window.openNewChatModal = openNewChatModal;
        window.closeNewChatModal = closeNewChatModal;
        window.toggleChatTypeOptions = toggleChatTypeOptions;
        window.createNewChat = createNewChat;
        window.openChatSettings = openChatSettings;
        window.closeChatSettingsModal = closeChatSettingsModal;
        window.addMemberToChat = addMemberToChat;
        window.removeMemberFromChat = removeMemberFromChat;
        window.saveChatSettings = saveChatSettings;
        window.refreshChats = refreshChats;
        window.adjustTextareaHeight = adjustTextareaHeight;
        window.handleTyping = handleTyping;
    </script>
</body>
</html>
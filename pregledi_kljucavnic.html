<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOMAGO bikes - Nadzorna plo≈°ƒça</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Ohrani vse obstojeƒçe stile */
        :root {
            --primary-blue: #004899;
            --secondary-yellow: #fbb900;
            --light-blue: #e9f0f7;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --bg-color: #f4f4f4;
            --card-bg: #ffffff;
            --text-color: #333333;
            --menu-bg: #004899;
            --nav-bg: #fbb900;
            --nav-text: #333333;
            --ok: #4caf50;
            --fail: #e53935;
            --warn: #fb8c00;
            --overdue: #d32f2f;
            --due-soon: #f57c00;
            --shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Ohrani vse preostale stile... */
    </style>
</head>
<body>
    <!-- Ohrani isti HTML strukturo -->
    <div class="header">
        <a href="dashboard.html"><img src="Bikes_kolesar_belorumen_RGB.png" alt="NOMAGO kolesar logo" class="logo-left" onerror="this.style.display='none'" style="cursor: pointer;"></a>
        <img src="Bikes_belorumen_RGB.png" alt="NOMAGO bikes logo" class="logo-center" onerror="this.style.display='none'">
        <div class="user-info" id="userInfo">
            <span id="userName"></span>
            <button class="logout-btn" onclick="logout()" title="Odjavi se">üö™</button>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Preklopi temo">üåì</button>
    </div>

    <!-- Ohrani preostalo strukturo... -->

    <script>
        // Global variables
        let currentUser = null;
        let inspectionData = {};
        let locations = [];
        let inspectionLog = [];
        let dismissedNotifications = JSON.parse(sessionStorage.getItem('dismissedNotifications') || '[]');

        // Check authentication
        function checkAuth() {
            currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Niste prijavljeni. Preusmerjamo vas na prijavno stran.');
                window.location.href = 'index.html';
                return null;
            }
            return currentUser;
        }

        // Load inspection statistics from Firebase
        async function loadInspectionStats() {
            try {
                // Load locations
                const locationsDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'system', 'locations')
                );
                locations = locationsDoc.exists() ? locationsDoc.data().data || [] : [];

                // Load inspection data
                const inspectionDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'system', 'inspectionData')
                );
                inspectionData = inspectionDoc.exists() ? inspectionDoc.data().data || {} : {};

                // Load inspection log
                const logsDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(window.firebaseDb, 'system', 'inspectionLog')
                );
                inspectionLog = logsDoc.exists() ? logsDoc.data().data || [] : [];
                
                updateDashboardStats();
                updateRecentActivity();
            } catch (error) {
                console.error('Error loading inspection stats:', error);
                document.getElementById('totalStations').textContent = 'ERR';
                document.getElementById('totalRacks').textContent = 'ERR';
                document.getElementById('overdueStations').textContent = 'ERR';
                document.getElementById('overdueRacks').textContent = 'ERR';
                document.getElementById('maintenanceNeeded').textContent = 'ERR';
            }
        }

        // Get accessible locations
        function getAccessibleLocations() {
            if (!currentUser.accessibleSystems || currentUser.accessibleSystems.length === 0) {
                return locations;
            }
            
            return locations.filter(location => {
                const hasSystemAccess = currentUser.accessibleSystems.includes(location.system);
                
                if (!currentUser.accessibleLocations || currentUser.accessibleLocations.length === 0) {
                    return hasSystemAccess;
                }
                
                return hasSystemAccess && 
                       currentUser.accessibleLocations.some(acc => acc.terminal === location.terminal);
            });
        }

        function getInspectionStatus(type, locationId, rackNumber = null) {
            if (type === 'station') {
                // Check if any rack at this station is overdue
                const location = locations.find(loc => loc.terminal === locationId);
                if (!location) return 'ok';
                
                for (let i = 1; i <= location.racks; i++) {
                    const rackStatus = getInspectionStatus('rack', locationId, i);
                    if (rackStatus === 'overdue') return 'overdue';
                }
                return 'ok';
            }
            
            const key = rackNumber ? `${locationId}-${rackNumber}` : `${locationId}-station`;
            const data = inspectionData[key];
            
            if (!data || !data.lastInspection) {
                return 'overdue';
            }
            
            const lastDate = new Date(data.lastInspection);
            const nextDate = new Date(lastDate);
            nextDate.setMonth(nextDate.getMonth() + 3);
            
            const now = new Date();
            const daysUntilDue = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysUntilDue < 0) return 'overdue';
            if (daysUntilDue <= 14) return 'warning';
            return 'ok';
        }

        function updateDashboardStats() {
            const accessibleLocations = getAccessibleLocations();
            
            let totalStations = accessibleLocations.length;
            let totalRacks = 0;
            let overdueStations = 0;
            let overdueRacks = 0;
            let maintenanceNeeded = 0;
            
            accessibleLocations.forEach(location => {
                totalRacks += location.racks;
                
                // Check station status
                if (getInspectionStatus('station', location.terminal) === 'overdue') {
                    overdueStations++;
                }
                
                // Check racks
                for (let i = 1; i <= location.racks; i++) {
                    const rackStatus = getInspectionStatus('rack', location.terminal, i);
                    if (rackStatus === 'overdue') overdueRacks++;
                    
                    const rackKey = `${location.terminal}-${i}`;
                    const rackData = inspectionData[rackKey];
                    if (rackData && rackData.currentStatus && rackData.currentStatus !== 'BP') {
                        maintenanceNeeded++;
                    }
                }
            });
            
            // Update UI
            document.getElementById('totalStations').textContent = totalStations;
            document.getElementById('totalRacks').textContent = totalRacks;
            document.getElementById('overdueStations').textContent = overdueStations;
            document.getElementById('overdueRacks').textContent = overdueRacks;
            document.getElementById('maintenanceNeeded').textContent = maintenanceNeeded;
        }

        // Ohrani preostale funkcije kot so updateRecentActivity, loadNotifications itd...

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = checkAuth();
            if (currentUser) {
                initializeUserDisplay();
                loadNotifications();
                loadInspectionStats();
                
                // Theme toggle functionality
                const themeToggle = document.getElementById('themeToggle');
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeToggle.textContent = '‚òÄÔ∏è';
                }
                
                themeToggle.addEventListener('click', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                    themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
                });

                // Update time every minute
                setInterval(() => {
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('sl-SI');
                }, 60000);

                // Refresh data every 5 minutes
                setInterval(() => {
                    loadNotifications();
                    loadInspectionStats();
                }, 5 * 60 * 1000);
            }
        });
    </script>
</body>
</html>
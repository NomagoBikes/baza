<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomago Bikes - Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        :root {
            --primary-blue: #004899;
            --secondary-yellow: #fbb900;
            --light-blue: #e9f0f7;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 72, 153, 0.1);
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
        }

        [data-theme="dark"] {
            --light-blue: #1a1a1a;
            --white: #2d2d2d;
            --text-dark: #f0f0f0;
            --text-light: #cccccc;
            --border-color: #444;
            --shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--light-blue);
            color: var(--text-dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: var(--shadow);
        }

        /* Sidebar styles */
        .sidebar {
            width: 300px;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1rem;
            background: var(--primary-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sidebar-controls {
            display: flex;
            gap: 0.5rem;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-bar {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--light-blue);
            color: var(--text-dark);
        }

        .chat-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            border-bottom-color: var(--primary-blue);
            color: var(--primary-blue);
            font-weight: 500;
        }

        .chat-tab:hover {
            background: rgba(0, 72, 153, 0.05);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(0, 72, 153, 0.05);
        }

        .chat-item.active {
            background: rgba(0, 72, 153, 0.1);
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .chat-item-name {
            font-weight: 500;
        }

        .chat-item-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .chat-item-preview {
            font-size: 0.9rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-unread {
            background: var(--primary-blue);
            color: white;
            border-radius: 10px;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* Main chat area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--light-blue);
        }

        .message {
            margin-bottom: 1rem;
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            position: relative;
        }

        .message-sent {
            background: var(--primary-blue);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message-received {
            background: var(--white);
            color: var(--text-dark);
            margin-right: auto;
            border-bottom-left-radius: 0;
            box-shadow: var(--shadow);
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .message-reply {
            font-size: 0.9rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 2px solid var(--primary-blue);
        }

        .message-reply-sender {
            font-weight: 500;
            font-size: 0.8rem;
        }

        .message-content {
            word-wrap: break-word;
        }

        .message-actions {
            display: none;
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 0.25rem;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 0.1rem;
            background: var(--white);
            color: var(--text-dark);
        }

        .message-action:hover {
            background: var(--light-blue);
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--white);
        }

        .reply-preview {
            padding: 0.5rem 1rem;
            background: var(--light-blue);
            border-left: 3px solid var(--primary-blue);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        .reply-preview-text {
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        .input-area {
            display: flex;
            gap: 0.5rem;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 40px;
            background: var(--light-blue);
            color: var(--text-dark);
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .attachment-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-blue);
            color: var(--primary-blue);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .reaction-picker {
            position: absolute;
            bottom: 50px;
            right: 0;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 0.5rem;
            display: none;
            z-index: 10;
        }

        .reaction-option {
            font-size: 1.2rem;
            padding: 0.25rem;
            cursor: pointer;
        }

        .reaction-option:hover {
            transform: scale(1.2);
        }

        .message-reactions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .reaction {
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 0.1rem 0.3rem;
            display: flex;
            align-items: center;
        }

        .reaction-count {
            font-size: 0.7rem;
            margin-left: 0.2rem;
        }

        /* Group info sidebar */
        .group-info {
            width: 300px;
            background: var(--white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .group-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .group-description {
            padding: 1rem;
            color: var(--text-light);
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }

        .group-members-title {
            padding: 1rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-member-button {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .member-list {
            flex: 1;
            overflow-y: auto;
        }

        .member-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .member-role {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .member-action {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .modal-header {
            padding: 1rem;
            background: var(--primary-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--light-blue);
            color: var(--text-dark);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--light-blue);
            color: var(--text-dark);
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .modal-button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-button-primary {
            background: var(--primary-blue);
            color: white;
            border: none;
        }

        .modal-button-secondary {
            background: var(--light-blue);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        /* Attachment preview */
        .attachment-preview {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .attachment-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--light-blue);
        }

        .attachment-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-light);
        }

        .remove-attachment {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* File input */
        .file-input {
            display: none;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar, .group-info {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }

            .chat-main {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Left sidebar - Conversations list -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Nomago Chat</div>
                <div class="sidebar-controls">
                    <button class="control-button" id="newChatButton">+</button>
                    <button class="control-button" id="themeToggle">🌙</button>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Išči pogovore...">
            </div>

            <div class="chat-tabs">
                <div class="chat-tab active" data-tab="private">Zasebni</div>
                <div class="chat-tab" data-tab="groups">Skupine</div>
            </div>

            <div class="chat-list" id="conversationList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title" id="currentChatTitle">Izberite pogovor</div>
                <div class="chat-actions">
                    <button class="control-button" id="groupInfoButton">i</button>
                </div>
            </div>

            <div class="chat-messages" id="messageContainer">
                <!-- Messages will be loaded here -->
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <h3>💬 Nomago Chat</h3>
                    <p>Izberite pogovor ali začnite novega</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="reply-preview" id="replyPreview" style="display: none;">
                    <div class="reply-preview-text" id="replyPreviewText"></div>
                    <button class="cancel-reply" id="cancelReply">&times;</button>
                </div>

                <div class="attachment-preview" id="attachmentPreview">
                    <!-- Attachment previews will appear here -->
                </div>

                <div class="input-area">
                    <button class="attachment-button" id="attachmentButton">📎</button>
                    <input type="file" class="file-input" id="fileInput" multiple>
                    <textarea class="message-input" id="messageInput" placeholder="Napišite sporočilo..." rows="1"></textarea>
                    <button class="send-button" id="sendButton">→</button>
                </div>
            </div>
        </div>

        <!-- Right sidebar - Group info -->
        <div class="group-info" id="groupInfoSidebar">
            <div class="group-header">
                <div class="group-title">Podrobnosti skupine</div>
                <button class="control-button" id="closeGroupInfo">&times;</button>
            </div>

            <div class="group-description" id="groupDescription">
                <!-- Group description will be loaded here -->
            </div>

            <div class="group-members-title">
                <span>Člani skupine</span>
                <button class="add-member-button" id="addMemberButton">+ Dodaj</button>
            </div>

            <div class="member-list" id="memberList">
                <!-- Group members will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Nov pogovor</div>
                <button class="close-modal" id="closeNewChatModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Izberite uporabnike</label>
                    <div id="userSelection">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Sporočilo</label>
                    <textarea class="form-textarea" id="newChatMessage" placeholder="Napišite sporočilo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="cancelNewChat">Prekliči</button>
                <button class="modal-button modal-button-primary" id="startNewChat">Začni pogovor</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Nova skupina</div>
                <button class="close-modal" id="closeNewGroupModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ime skupine</label>
                    <input type="text" class="form-input" id="groupName" placeholder="Vnesite ime skupine">
                </div>
                <div class="form-group">
                    <label class="form-label">Opis</label>
                    <textarea class="form-textarea" id="groupDescription" placeholder="Vnesite opis skupine (neobvezno)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Izberite člane</label>
                    <div id="groupUserSelection">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="cancelNewGroup">Prekliči</button>
                <button class="modal-button modal-button-primary" id="createNewGroup">Ustvari skupino</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Dodaj člane</div>
                <button class="close-modal" id="closeAddMemberModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Izberite uporabnike</label>
                    <div id="addMemberSelection">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="cancelAddMember">Prekliči</button>
                <button class="modal-button modal-button-primary" id="confirmAddMember">Dodaj člane</button>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            deleteDoc,
            updateDoc,
            serverTimestamp,
            onSnapshot,
            query,
            where,
            orderBy,
            addDoc
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrhPYvef_YZbISHxWeZL0MuQVAQYtTN4M",
            authDomain: "nomago-bikes-portal-f33da.firebaseapp.com",
            projectId: "nomago-bikes-portal-f33da",
            storageBucket: "nomago-bikes-portal-f33da.appspot.com",
            messagingSenderId: "647987655592",
            appId: "1:647987655592:web:7731d4ca344ce804bdc96d",
            measurementId: "G-D1CBD3V7ZV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make Firebase functions globally available
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseFunctions = {
            collection,
            doc,
            setDoc,
            getDoc,
            getDocs,
            deleteDoc,
            updateDoc,
            serverTimestamp,
            onSnapshot,
            query,
            where,
            orderBy,
            addDoc,
            ref,
            uploadBytes,
            getDownloadURL
        };

        console.log("Firebase initialized successfully");
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let currentChat = null;
        let replyToMessage = null;
        let attachments = [];
        let activeTab = 'private';

        // DOM elements
        const elements = {
            conversationList: document.getElementById('conversationList'),
            messageContainer: document.getElementById('messageContainer'),
            currentChatTitle: document.getElementById('currentChatTitle'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            attachmentButton: document.getElementById('attachmentButton'),
            fileInput: document.getElementById('fileInput'),
            attachmentPreview: document.getElementById('attachmentPreview'),
            replyPreview: document.getElementById('replyPreview'),
            replyPreviewText: document.getElementById('replyPreviewText'),
            cancelReply: document.getElementById('cancelReply'),
            newChatButton: document.getElementById('newChatButton'),
            newChatModal: document.getElementById('newChatModal'),
            closeNewChatModal: document.getElementById('closeNewChatModal'),
            cancelNewChat: document.getElementById('cancelNewChat'),
            startNewChat: document.getElementById('startNewChat'),
            userSelection: document.getElementById('userSelection'),
            newChatMessage: document.getElementById('newChatMessage'),
            groupInfoButton: document.getElementById('groupInfoButton'),
            groupInfoSidebar: document.getElementById('groupInfoSidebar'),
            closeGroupInfo: document.getElementById('closeGroupInfo'),
            groupDescription: document.getElementById('groupDescription'),
            memberList: document.getElementById('memberList'),
            addMemberButton: document.getElementById('addMemberButton'),
            newGroupModal: document.getElementById('newGroupModal'),
            closeNewGroupModal: document.getElementById('closeNewGroupModal'),
            cancelNewGroup: document.getElementById('cancelNewGroup'),
            createNewGroup: document.getElementById('createNewGroup'),
            groupName: document.getElementById('groupName'),
            groupDescription: document.getElementById('groupDescription'),
            groupUserSelection: document.getElementById('groupUserSelection'),
            addMemberModal: document.getElementById('addMemberModal'),
            closeAddMemberModal: document.getElementById('closeAddMemberModal'),
            cancelAddMember: document.getElementById('cancelAddMember'),
            confirmAddMember: document.getElementById('confirmAddMember'),
            addMemberSelection: document.getElementById('addMemberSelection'),
            themeToggle: document.getElementById('themeToggle'),
            chatTabs: document.querySelectorAll('.chat-tab')
        };

        // Initialize the chat application
        async function initChat() {
            // Check if user is logged in
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('chatUser').textContent = `${currentUser.ime} ${currentUser.priimek}`;
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'index.html';
                return;
            }

            // Load conversations
            loadConversations();

            // Set up event listeners
            setupEventListeners();

            // Set up real-time listeners
            setupRealtimeListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Message input
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            elements.sendButton.addEventListener('click', sendMessage);

            // Attachments
            elements.attachmentButton.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', handleFileUpload);

            // Reply
            elements.cancelReply.addEventListener('click', cancelReply);

            // New chat
            elements.newChatButton.addEventListener('click', openNewChatModal);
            elements.closeNewChatModal.addEventListener('click', closeNewChatModal);
            elements.cancelNewChat.addEventListener('click', closeNewChatModal);
            elements.startNewChat.addEventListener('click', startNewChat);

            // Group info
            elements.groupInfoButton.addEventListener('click', openGroupInfo);
            elements.closeGroupInfo.addEventListener('click', closeGroupInfo);
            elements.addMemberButton.addEventListener('click', openAddMemberModal);

            // New group
            elements.closeNewGroupModal.addEventListener('click', closeNewGroupModal);
            elements.cancelNewGroup.addEventListener('click', closeNewGroupModal);
            elements.createNewGroup.addEventListener('click', createNewGroup);

            // Add member
            elements.closeAddMemberModal.addEventListener('click', closeAddMemberModal);
            elements.cancelAddMember.addEventListener('click', closeAddMemberModal);
            elements.confirmAddMember.addEventListener('click', confirmAddMember);

            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleTheme);

            // Chat tabs
            elements.chatTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.chatTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    activeTab = tab.dataset.tab;
                    loadConversations();
                });
            });
        }

        // Set up real-time listeners
        function setupRealtimeListeners() {
            // Listen for new messages in current chat
            if (currentChat) {
                const messagesRef = window.firebaseFunctions.collection(window.firebaseDb, 'messages');
                const q = window.firebaseFunctions.query(
                    messagesRef,
                    window.firebaseFunctions.where('chatId', '==', currentChat.id),
                    window.firebaseFunctions.orderBy('timestamp', 'asc')
                );

                window.firebaseFunctions.onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            displayMessage(message);
                        }
                    });
                });
            }

            // Listen for conversation updates
            const conversationsRef = window.firebaseFunctions.collection(window.firebaseDb, 'conversations');
            const userConversationsQuery = window.firebaseFunctions.query(
                conversationsRef,
                window.firebaseFunctions.where('participants', 'array-contains', currentUser.uporabniskoIme)
            );

            window.firebaseFunctions.onSnapshot(userConversationsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        updateConversationList(change.doc.data());
                    }
                });
            });
        }

        // Load conversations
        async function loadConversations() {
            try {
                const conversationsRef = window.firebaseFunctions.collection(window.firebaseDb, 'conversations');
                let q;

                if (activeTab === 'private') {
                    q = window.firebaseFunctions.query(
                        conversationsRef,
                        window.firebaseFunctions.where('participants', 'array-contains', currentUser.uporabniskoIme),
                        window.firebaseFunctions.where('isGroup', '==', false)
                    );
                } else {
                    q = window.firebaseFunctions.query(
                        conversationsRef,
                        window.firebaseFunctions.where('participants', 'array-contains', currentUser.uporabniskoIme),
                        window.firebaseFunctions.where('isGroup', '==', true)
                    );
                }

                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                const conversations = [];

                querySnapshot.forEach((doc) => {
                    conversations.push(doc.data());
                });

                renderConversationList(conversations);
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // Render conversation list
        function renderConversationList(conversations) {
            elements.conversationList.innerHTML = '';

            if (conversations.length === 0) {
                elements.conversationList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-light);">
                        <p>Ni pogovorov</p>
                    </div>
                `;
                return;
            }

            conversations.forEach(conversation => {
                const conversationElement = document.createElement('div');
                conversationElement.className = 'chat-item';
                conversationElement.dataset.id = conversation.id;

                // Get other participant's name for private chats
                let title = conversation.name;
                let lastMessagePreview = conversation.lastMessage?.text || 'Ni sporočil';
                let lastMessageTime = conversation.lastMessage?.timestamp?.toDate() || new Date();

                if (!conversation.isGroup) {
                    const otherParticipant = conversation.participants.find(p => p !== currentUser.uporabniskoIme);
                    title = otherParticipant || 'Neznan uporabnik';
                }

                // Format time
                const timeString = formatTime(lastMessageTime);

                conversationElement.innerHTML = `
                    <div class="chat-item-header">
                        <div class="chat-item-name">${title}</div>
                        <div class="chat-item-time">${timeString}</div>
                    </div>
                    <div class="chat-item-preview">${lastMessagePreview}</div>
                `;

                conversationElement.addEventListener('click', () => {
                    loadChat(conversation);
                });

                elements.conversationList.appendChild(conversationElement);
            });
        }

        // Update conversation list with new or modified conversation
        function updateConversationList(conversation) {
            const existingConversation = document.querySelector(`.chat-item[data-id="${conversation.id}"]`);
            
            if (existingConversation) {
                // Update existing conversation
                let title = conversation.name;
                
                if (!conversation.isGroup) {
                    const otherParticipant = conversation.participants.find(p => p !== currentUser.uporabniskoIme);
                    title = otherParticipant || 'Neznan uporabnik';
                }
                
                const lastMessageTime = conversation.lastMessage?.timestamp?.toDate() || new Date();
                const timeString = formatTime(lastMessageTime);
                
                existingConversation.querySelector('.chat-item-name').textContent = title;
                existingConversation.querySelector('.chat-item-time').textContent = timeString;
                existingConversation.querySelector('.chat-item-preview').textContent = conversation.lastMessage?.text || 'Ni sporočil';
                
                // Move to top
                elements.conversationList.prepend(existingConversation);
            } else {
                // Add new conversation
                loadConversations();
            }
        }

        // Load chat messages
        async function loadChat(conversation) {
            currentChat = conversation;
            elements.currentChatTitle.textContent = conversation.isGroup ? conversation.name : 
                conversation.participants.find(p => p !== currentUser.uporabniskoIme);
            
            // Clear messages
            elements.messageContainer.innerHTML = '';
            
            try {
                const messagesRef = window.firebaseFunctions.collection(window.firebaseDb, 'messages');
                const q = window.firebaseFunctions.query(
                    messagesRef,
                    window.firebaseFunctions.where('chatId', '==', conversation.id),
                    window.firebaseFunctions.orderBy('timestamp', 'asc')
                );

                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                
                if (querySnapshot.empty) {
                    elements.messageContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-light);">
                            <h3>${conversation.isGroup ? conversation.name : 
                                conversation.participants.find(p => p !== currentUser.uporabniskoIme)}</h3>
                            <p>Začnite nov pogovor</p>
                        </div>
                    `;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    displayMessage(doc.data());
                });

                // Scroll to bottom
                elements.messageContainer.scrollTop = elements.messageContainer.scrollHeight;
                
                // Set up real-time listener for new messages
                setupRealtimeListeners();
                
                // Load group info if it's a group chat
                if (conversation.isGroup) {
                    loadGroupInfo(conversation);
                } else {
                    closeGroupInfo();
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display a message in the chat
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === currentUser.uporabniskoIme ? 'message-sent' : 'message-received'}`;
            
            let messageContent = `
                <div class="message-info">
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-time">${formatTime(message.timestamp.toDate())}</div>
                </div>
            `;
            
            if (message.replyTo) {
                messageContent += `
                    <div class="message-reply">
                        <div class="message-reply-sender">${message.replyTo.sender}</div>
                        <div>${message.replyTo.text}</div>
                    </div>
                `;
            }
            
            messageContent += `<div class="message-content">${message.text}</div>`;
            
            if (message.attachments && message.attachments.length > 0) {
                message.attachments.forEach(attachment => {
                    if (attachment.type.startsWith('image/')) {
                        messageContent += `<img src="${attachment.url}" style="max-width: 100%; max-height: 200px; margin-top: 0.5rem; border-radius: 8px;">`;
                    } else {
                        messageContent += `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.1); border-radius: 8px;">
                                <a href="${attachment.url}" target="_blank">${attachment.name}</a>
                            </div>
                        `;
                    }
                });
            }
            
            if (message.reactions && Object.keys(message.reactions).length > 0) {
                messageContent += `<div class="message-reactions">`;
                for (const [emoji, users] of Object.entries(message.reactions)) {
                    messageContent += `
                        <div class="reaction">
                            <span>${emoji}</span>
                            <span class="reaction-count">${users.length}</span>
                        </div>
                    `;
                }
                messageContent += `</div>`;
            }
            
            messageElement.innerHTML = messageContent;
            
            // Add right-click menu for reply and reactions
            messageElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, message);
            });
            
            elements.messageContainer.appendChild(messageElement);
            elements.messageContainer.scrollTop = elements.messageContainer.scrollHeight;
        }

        // Show message context menu
        function showMessageContextMenu(event, message) {
            // Remove any existing context menu
            const existingMenu = document.getElementById('messageContextMenu');
            if (existingMenu) existingMenu.remove();
            
            const menu = document.createElement('div');
            menu.id = 'messageContextMenu';
            menu.style.position = 'absolute';
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;
            menu.style.background = 'white';
            menu.style.borderRadius = '8px';
            menu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            menu.style.zIndex = '1000';
            menu.style.padding = '0.5rem 0';
            
            // Add reply option
            const replyOption = document.createElement('div');
            replyOption.textContent = 'Odgovori';
            replyOption.style.padding = '0.5rem 1rem';
            replyOption.style.cursor = 'pointer';
            replyOption.addEventListener('click', () => {
                setReplyToMessage(message);
                menu.remove();
            });
            menu.appendChild(replyOption);
            
            // Add reaction options
            const reactions = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
            const reactionContainer = document.createElement('div');
            reactionContainer.style.display = 'flex';
            reactionContainer.style.padding = '0.5rem';
            reactionContainer.style.gap = '0.5rem';
            
            reactions.forEach(emoji => {
                const reaction = document.createElement('div');
                reaction.textContent = emoji;
                reaction.style.cursor = 'pointer';
                reaction.style.fontSize = '1.2rem';
                reaction.addEventListener('click', () => {
                    addReaction(message, emoji);
                    menu.remove();
                });
                reactionContainer.appendChild(reaction);
            });
            
            menu.appendChild(reactionContainer);
            
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            document.addEventListener('click', closeMenu);
        }

        // Set reply to message
        function setReplyToMessage(message) {
            replyToMessage = message;
            elements.replyPreviewText.textContent = `${message.sender}: ${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}`;
            elements.replyPreview.style.display = 'flex';
            elements.messageInput.focus();
        }

        // Cancel reply
        function cancelReply() {
            replyToMessage = null;
            elements.replyPreview.style.display = 'none';
        }

        // Add reaction to message
        async function addReaction(message, emoji) {
            try {
                const messageRef = window.firebaseFunctions.doc(window.firebaseDb, 'messages', message.id);
                const messageDoc = await window.firebaseFunctions.getDoc(messageRef);
                
                if (messageDoc.exists()) {
                    const messageData = messageDoc.data();
                    const reactions = messageData.reactions || {};
                    
                    // Initialize reaction if it doesn't exist
                    if (!reactions[emoji]) {
                        reactions[emoji] = [];
                    }
                    
                    // Add or remove user's reaction
                    const userIndex = reactions[emoji].indexOf(currentUser.uporabniskoIme);
                    if (userIndex === -1) {
                        reactions[emoji].push(currentUser.uporabniskoIme);
                    } else {
                        reactions[emoji].splice(userIndex, 1);
                        if (reactions[emoji].length === 0) {
                            delete reactions[emoji];
                        }
                    }
                    
                    await window.firebaseFunctions.updateDoc(messageRef, {
                        reactions: reactions
                    });
                }
            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        }

        // Send message
        async function sendMessage() {
            const text = elements.messageInput.value.trim();
            
            if ((!text && attachments.length === 0) || !currentChat) return;
            
            try {
                const messageData = {
                    chatId: currentChat.id,
                    sender: currentUser.uporabniskoIme,
                    text: text,
                    timestamp: window.firebaseFunctions.serverTimestamp(),
                    readBy: [currentUser.uporabniskoIme]
                };
                
                if (replyToMessage) {
                    messageData.replyTo = {
                        id: replyToMessage.id,
                        sender: replyToMessage.sender,
                        text: replyToMessage.text
                    };
                }
                
                // Upload attachments if any
                if (attachments.length > 0) {
                    const uploadedAttachments = [];
                    
                    for (const attachment of attachments) {
                        const storageRef = window.firebaseFunctions.ref(window.firebaseStorage, `attachments/${currentChat.id}/${Date.now()}_${attachment.name}`);
                        await window.firebaseFunctions.uploadBytes(storageRef, attachment);
                        const downloadURL = await window.firebaseFunctions.getDownloadURL(storageRef);
                        
                        uploadedAttachments.push({
                            name: attachment.name,
                            type: attachment.type,
                            url: downloadURL
                        });
                    }
                    
                    messageData.attachments = uploadedAttachments;
                }
                
                // Add message to Firestore
                const messagesRef = window.firebaseFunctions.collection(window.firebaseDb, 'messages');
                const docRef = await window.firebaseFunctions.addDoc(messagesRef, messageData);
                
                // Update conversation with last message
                const conversationRef = window.firebaseFunctions.doc(window.firebaseDb, 'conversations', currentChat.id);
                await window.firebaseFunctions.updateDoc(conversationRef, {
                    lastMessage: {
                        id: docRef.id,
                        sender: currentUser.uporabniskoIme,
                        text: text || (attachments.length > 0 ? 'Priložena datoteka' : ''),
                        timestamp: window.firebaseFunctions.serverTimestamp()
                    },
                    updatedAt: window.firebaseFunctions.serverTimestamp()
                });
                
                // Clear input and reset state
                elements.messageInput.value = '';
                cancelReply();
                clearAttachments();
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                attachments.push(file);
                
                const attachmentElement = document.createElement('div');
                attachmentElement.className = 'attachment-item';
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        attachmentElement.innerHTML = `
                            <img src="${e.target.result}" class="attachment-image">
                            <div class="remove-attachment" data-name="${file.name}">&times;</div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    attachmentElement.innerHTML = `
                        <div class="attachment-icon">
                            📄
                            <div style="font-size: 0.7rem; margin-top: 0.5rem;">${file.name.substring(0, 5)}...</div>
                        </div>
                        <div class="remove-attachment" data-name="${file.name}">&times;</div>
                    `;
                }
                
                elements.attachmentPreview.appendChild(attachmentElement);
                
                // Add click event to remove button
                attachmentElement.querySelector('.remove-attachment').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeAttachment(file.name);
                });
            });
            
            // Reset file input
            event.target.value = '';
        }

        // Remove attachment
        function removeAttachment(fileName) {
            attachments = attachments.filter(file => file.name !== fileName);
            
            const attachmentElements = Array.from(elements.attachmentPreview.children);
            attachmentElements.forEach(element => {
                if (element.querySelector(`.remove-attachment[data-name="${fileName}"]`)) {
                    element.remove();
                }
            });
        }

        // Clear all attachments
        function clearAttachments() {
            attachments = [];
            elements.attachmentPreview.innerHTML = '';
        }

        // Open new chat modal
        async function openNewChatModal() {
            try {
                // Load users
                const usersRef = window.firebaseFunctions.collection(window.firebaseDb, 'uporabniki');
                const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                
                elements.userSelection.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.uporabniskoIme !== currentUser.uporabniskoIme) {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-selection-item';
                        userElement.innerHTML = `
                            <input type="checkbox" id="user-${user.uporabniskoIme}" value="${user.uporabniskoIme}">
                            <label for="user-${user.uporabniskoIme}">${user.ime} ${user.priimek} (${user.uporabniskoIme})</label>
                        `;
                        elements.userSelection.appendChild(userElement);
                    }
                });
                
                elements.newChatModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening new chat modal:', error);
            }
        }

        // Close new chat modal
        function closeNewChatModal() {
            elements.newChatModal.style.display = 'none';
            elements.newChatMessage.value = '';
            
            // Uncheck all users
            document.querySelectorAll('#userSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Start new chat
        async function startNewChat() {
            const selectedUsers = Array.from(document.querySelectorAll('#userSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            const messageText = elements.newChatMessage.value.trim();
            
            if (selectedUsers.length === 0) {
                alert('Izberite vsaj enega uporabnika');
                return;
            }
            
            try {
                // Check if conversation already exists
                const conversationsRef = window.firebaseFunctions.collection(window.firebaseDb, 'conversations');
                const participants = [currentUser.uporabniskoIme, ...selectedUsers].sort();
                
                const q = window.firebaseFunctions.query(
                    conversationsRef,
                    window.firebaseFunctions.where('participants', '==', participants),
                    window.firebaseFunctions.where('isGroup', '==', false)
                );
                
                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                
                let conversationId;
                
                if (querySnapshot.empty) {
                    // Create new conversation
                    const newConversation = {
                        participants: participants,
                        isGroup: false,
                        createdAt: window.firebaseFunctions.serverTimestamp(),
                        updatedAt: window.firebaseFunctions.serverTimestamp()
                    };
                    
                    const docRef = await window.firebaseFunctions.addDoc(conversationsRef, newConversation);
                    conversationId = docRef.id;
                    
                    // Update with ID
                    await window.firebaseFunctions.updateDoc(docRef, {
                        id: conversationId
                    });
                    
                    // Set the conversation data
                    newConversation.id = conversationId;
                    
                    // Load the chat
                    loadChat(newConversation);
                } else {
                    // Use existing conversation
                    const conversation = querySnapshot.docs[0].data();
                    loadChat(conversation);
                }
                
                // Send initial message if provided
                if (messageText) {
                    const messageData = {
                        chatId: conversationId,
                        sender: currentUser.uporabniskoIme,
                        text: messageText,
                        timestamp: window.firebaseFunctions.serverTimestamp(),
                        readBy: [currentUser.uporabniskoIme]
                    };
                    
                    const messagesRef = window.firebaseFunctions.collection(window.firebaseDb, 'messages');
                    await window.firebaseFunctions.addDoc(messagesRef, messageData);
                    
                    // Update conversation last message
                    const conversationRef = window.firebaseFunctions.doc(window.firebaseDb, 'conversations', conversationId);
                    await window.firebaseFunctions.updateDoc(conversationRef, {
                        lastMessage: {
                            id: conversationId,
                            sender: currentUser.uporabniskoIme,
                            text: messageText,
                            timestamp: window.firebaseFunctions.serverTimestamp()
                        },
                        updatedAt: window.firebaseFunctions.serverTimestamp()
                    });
                }
                
                closeNewChatModal();
                
            } catch (error) {
                console.error('Error starting new chat:', error);
            }
        }

        // Open group info sidebar
        function openGroupInfo() {
            if (!currentChat || !currentChat.isGroup) return;
            
            elements.groupInfoSidebar.style.display = 'flex';
        }

        // Close group info sidebar
        function closeGroupInfo() {
            elements.groupInfoSidebar.style.display = 'none';
        }

        // Load group info
        async function loadGroupInfo(conversation) {
            elements.groupDescription.textContent = conversation.description || 'Ni opisa';
            
            // Load members
            elements.memberList.innerHTML = '';
            
            conversation.participants.forEach(async (participant) => {
                const userRef = window.firebaseFunctions.doc(window.firebaseDb, 'uporabniki', participant);
                const userDoc = await window.firebaseFunctions.getDoc(userRef);
                
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    
                    const memberElement = document.createElement('div');
                    memberElement.className = 'member-item';
                    memberElement.innerHTML = `
                        <div class="member-avatar">${user.ime.charAt(0)}${user.priimek.charAt(0)}</div>
                        <div class="member-info">
                            <div class="member-name">${user.ime} ${user.priimek}</div>
                            <div class="member-role">${user.uporabniskoIme}</div>
                        </div>
                        ${participant === currentUser.uporabniskoIme ? '' : 
                        `<button class="member-action" data-user="${participant}">&times;</button>`}
                    `;
                    
                    elements.memberList.appendChild(memberElement);
                    
                    // Add event listener to remove button
                    const removeButton = memberElement.querySelector('.member-action');
                    if (removeButton) {
                        removeButton.addEventListener('click', () => {
                            removeGroupMember(participant);
                        });
                    }
                }
            });
        }

        // Open new group modal
        async function openNewGroupModal() {
            try {
                // Load users
                const usersRef = window.firebaseFunctions.collection(window.firebaseDb, 'uporabniki');
                const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                
                elements.groupUserSelection.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.uporabniskoIme !== currentUser.uporabniskoIme) {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-selection-item';
                        userElement.innerHTML = `
                            <input type="checkbox" id="group-user-${user.uporabniskoIme}" value="${user.uporabniskoIme}">
                            <label for="group-user-${user.uporabniskoIme}">${user.ime} ${user.priimek} (${user.uporabniskoIme})</label>
                        `;
                        elements.groupUserSelection.appendChild(userElement);
                    }
                });
                
                elements.newGroupModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening new group modal:', error);
            }
        }

        // Close new group modal
        function closeNewGroupModal() {
            elements.newGroupModal.style.display = 'none';
            elements.groupName.value = '';
            elements.groupDescription.value = '';
            
            // Uncheck all users
            document.querySelectorAll('#groupUserSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Create new group
        async function createNewGroup() {
            const groupName = elements.groupName.value.trim();
            const groupDescription = elements.groupDescription.value.trim();
            const selectedUsers = Array.from(document.querySelectorAll('#groupUserSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (!groupName) {
                alert('Vnesite ime skupine');
                return;
            }
            
            if (selectedUsers.length === 0) {
                alert('Izberite vsaj enega uporabnika');
                return;
            }
            
            try {
                const participants = [currentUser.uporabniskoIme, ...selectedUsers];
                
                const newGroup = {
                    name: groupName,
                    description: groupDescription,
                    participants: participants,
                    isGroup: true,
                    createdAt: window.firebaseFunctions.serverTimestamp(),
                    updatedAt: window.firebaseFunctions.serverTimestamp()
                };
                
                const conversationsRef = window.firebaseFunctions.collection(window.firebaseDb, 'conversations');
                const docRef = await window.firebaseFunctions.addDoc(conversationsRef, newGroup);
                
                // Update with ID
                await window.firebaseFunctions.updateDoc(docRef, {
                    id: docRef.id
                });
                
                // Set the group data
                newGroup.id = docRef.id;
                
                // Load the group chat
                loadChat(newGroup);
                closeNewGroupModal();
                
            } catch (error) {
                console.error('Error creating new group:', error);
            }
        }

        // Open add member modal
        async function openAddMemberModal() {
            if (!currentChat || !currentChat.isGroup) return;
            
            try {
                // Load users not already in group
                const usersRef = window.firebaseFunctions.collection(window.firebaseDb, 'uporabniki');
                const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                
                elements.addMemberSelection.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (!currentChat.participants.includes(user.uporabniskoIme)) {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-selection-item';
                        userElement.innerHTML = `
                            <input type="checkbox" id="add-user-${user.uporabniskoIme}" value="${user.uporabniskoIme}">
                            <label for="add-user-${user.uporabniskoIme}">${user.ime} ${user.priimek} (${user.uporabniskoIme})</label>
                        `;
                        elements.addMemberSelection.appendChild(userElement);
                    }
                });
                
                elements.addMemberModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening add member modal:', error);
            }
        }

        // Close add member modal
        function closeAddMemberModal() {
            elements.addMemberModal.style.display = 'none';
            
            // Uncheck all users
            document.querySelectorAll('#addMemberSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Confirm adding members
        async function confirmAddMember() {
            const selectedUsers = Array.from(document.querySelectorAll('#addMemberSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedUsers.length === 0) {
                alert('Izberite vsaj enega uporabnika');
                return;
            }
            
            try {
                const conversationRef = window.firebaseFunctions.doc(window.firebaseDb, 'conversations', currentChat.id);
                
                // Add new members to participants array
                await window.firebaseFunctions.updateDoc(conversationRef, {
                    participants: window.firebaseFunctions.arrayUnion(...selectedUsers),
                    updatedAt: window.firebaseFunctions.serverTimestamp()
                });
                
                // Update current chat data
                currentChat.participants = [...currentChat.participants, ...selectedUsers];
                
                // Reload group info
                loadGroupInfo(currentChat);
                closeAddMemberModal();
                
            } catch (error) {
                console.error('Error adding members:', error);
            }
        }

        // Remove group member
        async function removeGroupMember(username) {
            if (!confirm(`Ali ste prepričani, da želite odstraniti uporabnika ${username} iz skupine?`)) {
                return;
            }
            
            try {
                const conversationRef = window.firebaseFunctions.doc(window.firebaseDb, 'conversations', currentChat.id);
                
                // Remove member from participants array
                await window.firebaseFunctions.updateDoc(conversationRef, {
                    participants: window.firebaseFunctions.arrayRemove(username),
                    updatedAt: window.firebaseFunctions.serverTimestamp()
                });
                
                // Update current chat data
                currentChat.participants = currentChat.participants.filter(p => p !== username);
                
                // Reload group info
                loadGroupInfo(currentChat);
                
            } catch (error) {
                console.error('Error removing group member:', error);
            }
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const themeIcon = elements.themeToggle;
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load theme preference
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                elements.themeToggle.textContent = '☀️';
            }
        }

        // Format time
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const diffInDays = diff / (1000 * 60 * 60 * 24);
            
            if (diffInDays < 1) {
                return date.toLocaleTimeString('sl-SI', { hour: '2-digit', minute: '2-digit' });
            } else if (diffInDays < 7) {
                return date.toLocaleDateString('sl-SI', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('sl-SI', { day: '2-digit', month: '2-digit' });
            }
        }

        // Initialize the chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            initChat();
        });
    </script>
</body>
</html>